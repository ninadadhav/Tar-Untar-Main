#!/bin/bash

untar_process(){
echo $'\e[1;33m'"Starting Untar Process..."$'\e[0m'
echo
echo
cd /home/$USER/PSFT
a=(`cat /home/$USER/PSFT/parsed_file.csv | cut -d"," -f1`)
a1=${#a[@]}
b=(`cat /home/$USER/PSFT/parsed_file.csv | cut -d"," -f2-3 | sed -e "s/ /-/g" | sed -e "s/,/-/g"`)
b1=${#b[@]}
for ((u=0,v=0 ; u<${a1},v<${b1} ; u++,v++));
    do
       echo
       echo $'\e[1;36m'"Connecting to Target ${a[$u]} and Starting Untar..."$'\e[0m'
       echo
       echo $'\e[1;31m'"DO NOT KILL THE SHELL OR PRESS CTRL-C !!!"$'\e[0m'
       echo
       sleep 2
       LogMsg $LOGFILE "CONNECTING TO TARGET ${a[$u]}"
       echo
       ssh -n -q -o StrictHostKeyChecking=no -i /home/$USER/PSFT/keys/ocs_key $sudouser@${a[$u]} "
           cd $mountpoint2
           sudo tar -xvpPf ${b[$u]}.tar.gz 1> /tmp/remote_untar.log 2> /tmp/remote_untar_error.log"
       scp -i /home/$USER/PSFT/keys/ocs_key $sudouser@${a[$u]}:"/tmp/remote_untar.log /tmp/remote_untar_error.log" /home/$USER/PSFT/logs
       if [[ -s "/home/$USER/PSFT/logs/remote_untar_error.log" ]];
        then
          if [[ `cat /home/$USER/PSFT/logs/remote_untar_error.log` == *"Exiting with failure status"* ]];
               then
                   echo
                   echo $'\e[1;31m'"TAR Command failed...Exiting"$'\e[0m'
                   LogMsg $LOGFILE "TAR Command Failed"
                   cat /home/$USER/PSFT/logs/remote_untar_error.log
                   LogMsg $LOGFILE "`cat /home/$USER/PSFT/logs/remote_untar_error.log`"
                   exit 1
               else
                   echo
                   echo $'\e[1;31m'"TAR Command failed...Exiting"$'\e[0m'
                   LogMsg $LOGFILE "TAR Command Failed"
                   cat /home/$USER/PSFT/logs/remote_untar_error.log
                   LogMsg $LOGFILE "`cat /home/$USER/PSFT/logs/remote_untar_error.log`"
                   exit 1
         fi
 else
        cat /home/$USER/PSFT/logs/remote_untar.log
        LogMsg $LOGFILE "`cat /home/$USER/PSFT/logs/remote_untar.log`"
        echo
        echo $'\e[1;32m'"Untar Process completed successfully..."$'\e[0m'
        LogMsg $LOGFILE "Untar Process Completed"
       fi
    done
    echo
    sleep 1
}

untar_process
